<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thống kê doanh thu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            background-color: #f8f9fa;
            font-size: 14px;
        }
        .card-title {
            font-weight: 500;
            color: #6c757d;
        }
        .card .bi {
            font-size: 2.8rem;
            opacity: 0.3;
        }
        #revenueChart {
            max-height: 400px;
        }
    </style>
</head>
<body>
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    <!-- Toasts will appear here -->
</div>
<div class="container mt-4">
    <!-- Bộ lọc thống kê -->
    <form class="row g-3 mb-4 align-items-end" method="get" action="/quan-tri/thong-ke-doanh-thu">
        <div class="col-auto">
            <label class="form-label">Loại bộ lọc</label>
            <select class="form-control" id="filterType" name="filterType" onchange="this.form.submit()">
                <option value="month" th:selected="${filterType == 'month'}">Theo tháng</option>
                <option value="week" th:selected="${filterType == 'week'}">Theo tuần</option>
            </select>
        </div>
        <div class="col-auto" th:if="${filterType == 'month'}">
            <label for="month" class="form-label">Chọn tháng</label>
            <select class="form-control" id="month" name="month" onchange="this.form.submit()">
                <option value="" th:selected="${month == null}">Chọn tháng</option>
                <option th:each="m : ${#numbers.sequence(1, 12)}"
                        th:value="${m}"
                        th:text="'Tháng ' + ${m}"
                        th:selected="${month != null and month == m}"></option>
            </select>
        </div>
        <div class="col-auto" th:if="${filterType == 'week'}">
            <label for="month" class="form-label">Chọn tháng</label>
            <select class="form-control" id="month" name="month" onchange="this.form.submit()" th:data-selected="${month}">
                <option value="" th:selected="${month == null}">Cả năm</option>
                <option th:each="m : ${#numbers.sequence(1, 12)}"
                        th:value="${m}"
                        th:text="'Tháng ' + ${m}"
                        th:selected="${month != null and month == m}"></option>
            </select>
        </div>
        <div class="col-auto" th:if="${filterType == 'week'}">
            <label for="week" class="form-label">Chọn tuần</label>
            <select class="form-control" id="week" name="week" onchange="this.form.submit()" th:data-selected="${week}">
                <option value="" th:selected="${week == null}">Tuần hiện tại</option>
                <option th:each="w : ${#numbers.sequence(1, 53)}"
                        th:value="${w}"
                        th:text="'Tuần ' + ${w}"
                        th:selected="${week != null and week == w}"></option>
            </select>
        </div>
        <div class="col-auto">
            <label for="year" class="form-label">Chọn năm</label>
            <select class="form-control" id="year" name="year" onchange="this.form.submit()">
                <option value="" th:selected="${year == null}">Chọn năm</option>
                <option th:each="y : ${#numbers.sequence(T(java.time.LocalDate).now().getYear() - 5, T(java.time.LocalDate).now().getYear())}"
                        th:value="${y}"
                        th:text="${y}"
                        th:selected="${year != null and year == y}"></option>
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Xem</button>
        </div>
    </form>
    <!-- Bảng tổng hợp chỉ số doanh thu -->
    <div class="row mb-4" th:if="${dashboard != null}">
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Tổng số đơn hàng</h6>
                        <h4 class="card-text text-primary fw-bold" th:text="${dashboard.tongSoDon} ?: 0"></h4>
                    </div>
                    <i class="bi bi-box-seam text-primary"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Tổng doanh thu</h6>
                        <h4 class="card-text text-success fw-bold" th:text="${dashboard.tongDoanhThu != null} ? ${#numbers.formatDecimal(dashboard.tongDoanhThu, 0, 'COMMA', 0, 'POINT')} + ' VNĐ' : '0 VNĐ'"></h4>
                    </div>
                    <i class="bi bi-cash-coin text-success"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Sản phẩm bán ra</h6>
                        <h4 class="card-text text-info fw-bold" th:text="${dashboard.tongSanPhamBan} ?: 0"></h4>
                    </div>
                    <i class="bi bi-stack text-info"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Khách hàng mới</h6>
                        <h4 class="card-text text-warning fw-bold" th:text="${dashboard.soKhachHangMoi} ?: 0"></h4>
                    </div>
                    <i class="bi bi-person-plus-fill text-warning"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4" th:if="${dashboard == null}">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                Không có dữ liệu thống kê để hiển thị.
            </div>
        </div>
    </div>

    <!-- Biểu đồ doanh thu -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-white pb-0 border-0">
            <h5 class="card-title fw-bold"><i class="bi bi-bar-chart-line me-2"></i>Biểu đồ doanh thu theo thời gian</h5>
        </div>
        <div class="card-body">
            <canvas id="revenueChart" height="80"></canvas>
            <div id="noDataMessage" class="alert alert-info text-center" style="display: none;">
                Không có dữ liệu doanh thu để hiển thị.
            </div>
        </div>
    </div>

    <!-- Bảng sản phẩm bán chạy -->
    <div class="card mb-4 shadow-sm border-0" th:if="${dashboard != null and dashboard.sanPhamBanChayList != null and not #lists.isEmpty(dashboard.sanPhamBanChayList)}">
        <div class="card-header bg-white pb-0 border-0">
            <h5 class="card-title fw-bold"><i class="bi bi-trophy me-2"></i>Top sản phẩm bán chạy</h5>
        </div>
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th>STT</th>
                    <th>Tên sản phẩm</th>
                    <th>Số lượng bán</th>
                    <th>Doanh thu</th>
                    <th>Tỷ trọng doanh thu</th>
                    <th>Tồn kho</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="sp, iterStat : ${dashboard.sanPhamBanChayList}">
                    <td th:text="${iterStat.count}"></td>
                    <td class="fw-bold" th:text="${sp.tenSanPham}"></td>
                    <td th:text="${sp.soLuongBan}"></td>
                    <td th:text="${#numbers.formatDecimal(sp.doanhThu, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></td>
                    <td>
                        <span th:text="${dashboard.tongDoanhThu > 0 ? (sp.doanhThu * 100.0 / dashboard.tongDoanhThu) : 0} + '%'"></span>
                    </td>
                    <td class="text-danger" th:text="${sp.tonKho}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            // Lấy dữ liệu từ backend
            let thongKeList = /*[[${thongKeListJson}]]*/ [];
            if (typeof thongKeList === 'string') {
                try {
                    thongKeList = JSON.parse(thongKeList);
                } catch (e) {
                    thongKeList = [];
                }
            }

            const filterType = /*[[${filterType}]]*/ 'month';
            const selectedYear = /*[[${year}]]*/ null;
            const selectedWeek = /*[[${week}]]*/ null;
            const selectedMonth = /*[[${month}]]*/ null;

            console.log('Filter Type:', filterType);
            console.log('thongKeList:', thongKeList);
            console.log('Year:', selectedYear, 'Month:', selectedMonth, 'Week:', selectedWeek);

            // Hàm chuẩn hóa định dạng ngày
            function normalizeDateString(dateStr) {
                if (typeof dateStr === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    const [year, month, day] = dateStr.split('-');
                    const date = new Date(year, month - 1, day);
                    if (isNaN(date.getTime())) {
                        console.error('Invalid date:', dateStr);
                        return null;
                    }
                    return date.toLocaleDateString('vi-VN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                }
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    console.error('Invalid date:', dateStr);
                    return null;
                }
                return date.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }

            // Hàm tạo labels cho tuần (ISO-8601, tuần bắt đầu từ Thứ 2)
            function generateWeekLabels(year, week) {
                const labels = [];
                // ISO tuần 1 là tuần có ngày 4/1
                const jan4Utc = new Date(Date.UTC(year, 0, 4));
                const jan4IsoDow = jan4Utc.getUTCDay() === 0 ? 7 : jan4Utc.getUTCDay(); // 1..7 (Mon..Sun)
                // Thứ 2 của tuần 1
                const mondayWeek1Utc = new Date(jan4Utc);
                mondayWeek1Utc.setUTCDate(jan4Utc.getUTCDate() - (jan4IsoDow - 1));

                // Thứ 2 của tuần cần lấy
                const mondayTargetUtc = new Date(mondayWeek1Utc);
                mondayTargetUtc.setUTCDate(mondayWeek1Utc.getUTCDate() + (week - 1) * 7);

                // Sinh 7 ngày của tuần
                for (let i = 0; i < 7; i++) {
                    const d = new Date(mondayTargetUtc);
                    d.setUTCDate(mondayTargetUtc.getUTCDate() + i);
                    const [y, m, day] = d.toISOString().split('T')[0].split('-');
                    labels.push(`${day}/${m}/${y}`);
                }
                return labels;
            }

            // Hàm tạo labels cho tháng
            function generateMonthLabels(year, month) {
                const labels = [];
                const daysInMonth = new Date(year, month, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month - 1, day);
                    labels.push(date.toLocaleDateString('vi-VN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    }));
                }
                return labels;
            }

            // Xử lý dữ liệu và labels
            let labels = [];
            let doanhThuData = [];

            if (filterType === 'week' && selectedYear && selectedWeek) {
                labels = generateWeekLabels(selectedYear, selectedWeek);
                doanhThuData = new Array(labels.length).fill(0);

                thongKeList.forEach(item => {
                    console.log('Raw item:', JSON.stringify(item));
                    if (item.thoiGian) {
                        const itemDate = normalizeDateString(item.thoiGian);
                        console.log('Normalized itemDate:', itemDate, 'tongDoanhThu:', item.tongDoanhThu);
                        const index = labels.indexOf(itemDate);
                        console.log('Label index:', index);
                        if (index !== -1) {
                            doanhThuData[index] = item.tongDoanhThu || 0;
                        } else {
                            console.warn('Date not found in labels:', itemDate);
                        }
                    }
                });
            } else if (filterType === 'month' && selectedYear && selectedMonth) {
                labels = generateMonthLabels(selectedYear, selectedMonth);
                doanhThuData = new Array(labels.length).fill(0);

                thongKeList.forEach(item => {
                    console.log('Raw item:', JSON.stringify(item));
                    if (item.thoiGian) {
                        const itemDate = normalizeDateString(item.thoiGian);
                        console.log('Normalized itemDate:', itemDate, 'tongDoanhThu:', item.tongDoanhThu);
                        const index = labels.indexOf(itemDate);
                        console.log('Label index:', index);
                        if (index !== -1) {
                            doanhThuData[index] = item.tongDoanhThu || 0;
                        } else {
                            console.warn('Date not found in labels:', itemDate);
                        }
                    }
                });
            } else {
                if (thongKeList && thongKeList.length > 0) {
                    labels = thongKeList.map(item => {
                        if (item.thoiGian) {
                            return normalizeDateString(item.thoiGian) || '';
                        }
                        return '';
                    });
                    doanhThuData = thongKeList.map(item => item.tongDoanhThu || 0);
                }
            }

            console.log('Final Labels:', labels);
            console.log('Final Data:', doanhThuData);

            // Kiểm tra và hiển thị biểu đồ
            const canvas = document.getElementById('revenueChart');
            const noDataMessage = document.getElementById('noDataMessage');

            if (!labels.length || doanhThuData.every(val => val === 0)) {
                canvas.style.display = 'none';
                noDataMessage.style.display = 'block';
                console.log('No data to display chart');
            } else {
                canvas.style.display = 'block';
                noDataMessage.style.display = 'none';

                const data = {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: doanhThuData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(54, 162, 235)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(54, 162, 235)',
                        pointRadius: 4,
                        pointHoverRadius: 7
                    }]
                };

                const config = {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: filterType === 'week' ? 'Ngày trong tuần' : 'Ngày trong tháng'
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Doanh thu (VNĐ)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'tr';
                                        if (value >= 1000) return (value / 1000).toFixed(1) + 'k';
                                        return value.toLocaleString('vi-VN');
                                    }
                                },
                                grid: {
                                    borderDash: [5, 5]
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 12 },
                                callbacks: {
                                    title: function(context) {
                                        return `Ngày: ${context[0].label}`;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('vi-VN', {
                                                style: 'currency',
                                                currency: 'VND'
                                            }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                };

                const ctx = canvas.getContext('2d');
                new Chart(ctx, config);
                console.log('Chart created successfully');
            }

            // Cập nhật danh sách tuần theo ISO, có thể lọc theo tháng
            const yearSelect = document.getElementById('year');
            const weekSelect = document.getElementById('week');
            const monthSelect = document.getElementById('month');

            function updateWeekOptions() {
                const year = parseInt(yearSelect.value);
                const month = parseInt(monthSelect ? monthSelect.value : '');
                if (!year) return;

                function getMondayOfISOWeek1(y) {
                    const jan4Utc = new Date(Date.UTC(y, 0, 4));
                    const isoDow = jan4Utc.getUTCDay() === 0 ? 7 : jan4Utc.getUTCDay();
                    const monday = new Date(jan4Utc);
                    monday.setUTCDate(jan4Utc.getUTCDate() - (isoDow - 1));
                    return monday;
                }

                function getRangeOfISOWeek(y, w) {
                    const mondayWeek1 = getMondayOfISOWeek1(y);
                    const monday = new Date(mondayWeek1);
                    monday.setUTCDate(mondayWeek1.getUTCDate() + (w - 1) * 7);
                    const sunday = new Date(monday);
                    sunday.setUTCDate(monday.getUTCDate() + 6);
                    return { monday, sunday };
                }

                // Tính tổng số tuần trong năm y theo ISO: tuần của 28/12 thuộc tuần cuối cùng của năm
                function getISOWeeksInYear(y) {
                    const dec28 = new Date(Date.UTC(y, 11, 28));
                    const jan4 = new Date(Date.UTC(y, 0, 4));
                    const mondayWeek1 = getMondayOfISOWeek1(y);
                    const diffDays = Math.floor((dec28 - mondayWeek1) / (24 * 3600 * 1000));
                    return Math.floor(diffDays / 7) + 1;
                }

                const totalWeeks = getISOWeeksInYear(year);
                const selectedWeek = weekSelect.dataset.selected;
                weekSelect.innerHTML = '<option value="">Tuần hiện tại</option>';

                for (let w = 1; w <= totalWeeks; w++) {
                    const { monday, sunday } = getRangeOfISOWeek(year, w);
                    // Lọc theo tháng nếu có: nếu bất kỳ ngày trong khoảng thuộc tháng đã chọn (1..12)
                    if (!isNaN(month)) {
                        const m1 = monday.getUTCMonth() + 1;
                        const m2 = sunday.getUTCMonth() + 1;
                        if (m1 !== month && m2 !== month) {
                            // kiểm tra nếu khoảng giao với tháng bằng cách duyệt từng ngày (an toàn)
                            let intersects = false;
                            for (let i = 0; i < 7; i++) {
                                const d = new Date(monday);
                                d.setUTCDate(monday.getUTCDate() + i);
                                if ((d.getUTCMonth() + 1) === month) { intersects = true; break; }
                            }
                            if (!intersects) continue;
                        }
                    }

                    const md = monday.toISOString().split('T')[0].split('-');
                    const sd = sunday.toISOString().split('T')[0].split('-');
                    const label = `Tuần ${w} (${md[2]}/${md[1]} - ${sd[2]}/${sd[1]})`;

                    const option = document.createElement('option');
                    option.value = w;
                    option.text = label;
                    if (selectedWeek && parseInt(selectedWeek) === w) option.selected = true;
                    weekSelect.appendChild(option);
                }
            }

            yearSelect.addEventListener('change', updateWeekOptions);
            if (monthSelect) monthSelect.addEventListener('change', updateWeekOptions);
            if (yearSelect.value) {
                updateWeekOptions();
            }
        });
        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const toastContainer = document.getElementById('toastContainer');

        function showToast(message) {
            const toastEl = document.createElement('div');
            toastEl.classList.add('toast', 'align-items-center', 'text-bg-danger', 'border-0');
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');

            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
            toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const filterType = document.getElementById('filterType');
            const month = document.getElementById('month');
            const week = document.getElementById('week');
            const year = document.getElementById('year');

            form.addEventListener('submit', function(e) {
                if (filterType.value === 'month' && month && !month.value && year.value) {
                    e.preventDefault();
                    showToast('Vui lòng chọn tháng.');
                } else if (filterType.value === 'week' && week && !week.value && year.value) {
                    // Cho phép submit nếu không chọn tuần (Tuần hiện tại)
                } else if (!year.value) {
                    e.preventDefault();
                    showToast('Vui lòng chọn năm.');
                }
            });

            const backendError = /*[[${dateError}]]*/ null;
            if (backendError) {
                showToast(backendError);
            }
        });
        /*]]>*/
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterType = document.getElementById('filterType');
            const month = document.getElementById('month');
            const week = document.getElementById('week');
            const year = document.getElementById('year');
            const form = filterType.form;

            function autoSubmitIfValid() {
                if (filterType.value === 'month' && month.value && year.value) {
                    form.submit();
                } else if (filterType.value === 'week' && year.value) {
                    form.submit();
                }
            }

            filterType.addEventListener('change', autoSubmitIfValid);
            if (month) month.addEventListener('change', autoSubmitIfValid);
            if (week) week.addEventListener('change', autoSubmitIfValid);
            year.addEventListener('change', autoSubmitIfValid);
        });
    </script>
</div>
</body>
</html>